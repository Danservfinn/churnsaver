# Churn Saver - Migration Verification Workflow
# This workflow verifies database migrations are valid and can be applied safely

name: Migration Verification

on:
  # Manual trigger for testing migrations before deployment
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment (staging|production)'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
  # Trigger on migration file changes
  pull_request:
    paths:
      - 'infra/migrations/*.sql'
      - '.github/workflows/prd-check-migration.yml'

jobs:
  verify-migrations:
    runs-on: ubuntu-latest

    environment: ${{ inputs.environment || 'staging' }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'pnpm'

    - name: Install pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 9.15.9

    - name: Install dependencies
      working-directory: apps/web
      run: pnpm install --frozen-lockfile

    - name: Setup test database (ephemeral)
      run: |
        # Start PostgreSQL service
        sudo systemctl start postgresql

        # Create test database
        sudo -u postgres createdb churn_saver_test || true

        # Set environment for migration testing
        echo "DATABASE_URL=postgresql://postgres:postgres@localhost:5432/churn_saver_test" >> $GITHUB_ENV

    - name: Verify and apply migrations to test database
      run: |
        cd apps/web
        node scripts/init-db.js
      env:
        # Use ephemeral test database
        DATABASE_URL: postgresql://postgres:postgres@localhost:5432/churn_saver_test

    - name: Run basic smoke tests
      run: |
        cd apps/web
        # Test basic queries work
        node -e "
        const { sql } = require('./src/lib/db');
        const main = async () => {
          try {
            await sql.init();
            const tables = await sql.select('SELECT tablename FROM pg_tables WHERE schemaname = \\'public\\' AND tablename LIKE \\'%churn%\\'');
            console.log('Found tables:', tables.length);
            process.exit(0);
          } catch (e) {
            console.error('Database smoke test failed:', e.message);
            process.exit(1);
          }
        };
        main();
        "

    - name: Validate migration rollout safety
      run: |
        cd apps/web
        node -e "
        const fs = require('fs');
        const migrationPath = 'infra/migrations/001_init.sql';
        const content = fs.readFileSync(migrationPath, 'utf-8');

        // Check for basic safety patterns
        const unsafePatterns = [
          /DROP TABLE/i,
          /DELETE FROM/i,
          /TRUNCATE/i,
          /UPDATE.*SET/i
        ];

        const hasUnsafe = unsafePatterns.some(pattern => pattern.test(content));

        if (hasUnsafe) {
          console.log('‚ö†Ô∏è  Migration contains potentially unsafe operations');
          console.log('   Manual review recommended before production deployment');
        } else {
          console.log('‚úÖ Migration appears safe for automated deployment');
        }

        // Check for required IF NOT EXISTS clauses
        const hasIfNotExists = content.includes('IF NOT EXISTS');
        if (!hasIfNotExists) {
          console.log('‚ö†Ô∏è  Migration may not have IF NOT EXISTS clauses');
          console.log('   Consider adding for safe redeployment');
        } else {
          console.log('‚úÖ Migration includes safety checks (IF NOT EXISTS)');
        }
        "

    - name: Generate migration verification report
      run: |
        echo "# Migration Verification Report" > migration-report.md
        echo "- **Status**: ‚úÖ Valid and ready for deployment" >> migration-report.md
        echo "- **Environment**: ${{ inputs.environment || 'staging' }}" >> migration-report.md
        echo "- **Timestamp**: $(date)" >> migration-report.md
        echo "- **Migration file**: infra/migrations/001_init.sql" >> migration-report.md
        echo "- **Test database**: ‚úì Tables created successfully" >> migration-report.md
        echo "- **Smoke tests**: ‚úì Basic queries working" >> migration-report.md
        echo "" >> migration-report.md

        cat migration-report.md

    - name: Comment on PR (if PR trigger)
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const report = fs.readFileSync('migration-report.md', 'utf-8');

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: '# üîç Migration Verification Complete\n\n' + report
          });

    - name: Upload report as artifact
      uses: actions/upload-artifact@v4
      with:
        name: migration-verification-report
        path: migration-report.md
